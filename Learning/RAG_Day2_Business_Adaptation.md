# 🟦 Day 2: ToB 场景下，RAG 怎么「因公司而异」

## 核心原则：你不是在「做 RAG」，你是在「适配业务」

RAG 本身很简单，但**成败在调参和设计**。不同行业的 RAG 打法完全不同。

---

## 📊 公司类型 × RAG 重点矩阵

| 公司类型 | RAG 核心挑战 | 调参要点 | Demo 策略 |
|---------|-----------|--------|---------|
| **SaaS 产品** | 权限隔离、多租户 | 检索前过滤、隔离索引 | 展示"我看不到别的客户数据" |
| **制造业** | PDF/图纸识别、结构化 | 增强 OCR、特殊 Embedding | 展示"图纸规格准确查询" |
| **法务/合规** | 溯源精确、低错误率 | 高 Top-K 过滤、引用核对 | 展示"准确定位条款位置" |
| **医疗/保险** | 低幻觉、高可信 | 严格相似度阈值、审核流 | 展示"避免错误医学建议" |
| **内部知识库** | 更新频率快、版本管理 | 增量索引、版本控制 | 展示"实时知识同步" |

---

## 🔍 FDE 必备的 5 个问题诊断法

### 问题 1️⃣：文档在哪里？格式？

**这个问题决定：基础架构**

```
答案可能是：

场景 A: "都在我们的内部 Wiki（Confluence）里"
  → 方案: Confluence API + 定期同步 + 权限管理
  → 难度: ⭐⭐⭐ (权限继承最复杂)

场景 B: "Word/PDF/Excel 分散在各个部门的网盘"
  → 方案: 扫描所有网盘 + OCR + 结构化解析
  → 难度: ⭐⭐⭐⭐ (识别率、重复删除)

场景 C: "全在数据库里，结构化很好"
  → 方案: 直接做 Text2SQL 或混合检索
  → 难度: ⭐⭐ (最简单的场景)

场景 D: "图纸、原理图、CAD 文件"
  → 方案: 多模态 Embedding + 图片描述生成
  → 难度: ⭐⭐⭐⭐⭐ (最复杂)
```

**FDE 应该问的追问：**
- 这些文档有版本控制吗？
- 权限是什么体系？（部门级还是个人级？）
- 多久更新一次？每次更新多少内容？

---

### 问题 2️⃣：更新频率？

**这个问题决定：索引更新策略**

```
更新频率         → 推荐方案              → 成本/复杂度
─────────────────────────────────────────────────────

每月或更少       → 批量更新，离线处理      ⭐ (最便宜)
  (典型: 规章制度)   - 固定时间全量重建索引

每周              → 增量更新              ⭐⭐
  (典型: 产品文档)   - 检测文件变化
                   - 只重建变化部分

每天              → 实时更新             ⭐⭐⭐
  (典型: 行业资讯)   - 监听文件系统或 API
                   - 新文档即时索引

实时/分钟级      → 流式处理 + 队列        ⭐⭐⭐⭐ (最复杂)
  (典型: 聊天记录)   - Kafka/Redis 消息队列
                   - 异步处理索引
```

**例子：**
```python
# 批量更新 (每月一次)
if date.today() == 1:  # 每月1号
    rebuild_full_index()

# 增量更新 (每天)
for new_file in find_new_files():
    embed_and_index(new_file)

# 实时更新 (Kafka)
@listen_to_kafka_topic("documents")
def index_document(doc):
    embed_and_index(doc)
```

---

### 问题 3️⃣：谁用？（员工 vs 客户）

**这个问题决定：权限模型 & 隐私**

```
用户类型        权限模型              风险              部署方案
───────────────────────────────────────────────────────────────

员工用          简单过滤              数据泄露 ⭐⭐      内网 + VPN
  (SaaS)        - 部门级权限          敏感信息暴露
                - 子公司隔离

B2B 客户        复杂隔离              数据隔离失败       Docker + 隔离
  (多租户)      - 租户级隔离          ⭐⭐⭐ 
                - 加密向量             客户投诉
                - 专用索引

B2C 客户        公开内容              几乎无风险         公网部署
  (FAQ)         - 统一索引            ⭐
                - 版本化管理

合规/法务       严格审查              违规风险 ⭐⭐⭐⭐  离线处理 + 审核
  (要溯源)      - 人工复核            监管处罚
                - 完整日志            数据合规
```

**现实例子：**
```
❌ 错误做法（多个被投公司的教训）:
   SaaS 创业公司用了单一索引，客户 A 的问题被检索到了客户 B 的文档
   
✅ 正确做法:
   SaaS 创业公司为每个租户创建独立的向量索引
   - tenant_index_001_customer_A
   - tenant_index_002_customer_B
   检索前先验证租户权限
```

---

### 问题 4️⃣：错一次能不能接受？

**这个问题决定：容错级别 & 验证机制**

```
容错等级      典型场景                  验证机制              Top-K策略
─────────────────────────────────────────────────────────────────

✅ 错了不紧要  FAQ、内部 Wiki           相似度展示           K=3-5
  - 公司介绍    常见问题 Q&A            提示"可能不准"        宽松阈值
  - 产品演示    员工自助服务

⚠️  错了有影响  客户成功、销售           人工审核 + 相似度       K=5-7
  - 配置指导    产品文档                显示来源和置信度       严格阈值
  - 技术支持    Troubleshooting

🔴 绝对不能错  医疗建议、法律意见       多步验证 + LLM         K=3
  - 诊断建议    合同条款查询             审查机制              人工必审
  - 用药指导    财务建议                 完整的审计日志         见仁见智
  - 合规查询
```

**实现例子：**
```python
# FAQ (低容错)
result = retrieve_and_answer(question, top_k=3)
return result

# 产品技术支持 (中容错)
result = retrieve_and_answer(question, top_k=5)
if result.similarity < 0.7:
    return f"系统不太确定，建议联系技术支持: {support_link}"
else:
    return result

# 法律咨询 (零容错)
result = retrieve_and_answer(question, top_k=3)
if result.similarity < 0.85:
    return "系统无法确定答案，请联系法务部"
else:
    return result + f"来源: {result.source} ({result.exact_location})"
```

---

### 问题 5️⃣：是否要可追溯？

**这个问题决定：日志 & 审计机制**

```
追溯需求      典型行业         实现成本    实现难度
───────────────────────────────────────────────

不需要        电商客服         ⭐         ⭐
(用户 不关心   FAQ               无额外      简单
 来源)        内部 Wiki

简单追溯      SaaS 产品支持     ⭐⭐       ⭐
(告诉用户      官方文档          记录文档    记录
 来源文件)     博客文章          名称、版本  即可

精确追溯      法律/合规         ⭐⭐⭐⭐⭐  ⭐⭐⭐⭐
(精确到段落    医疗建议          完整链路    复杂
 行号)         财务建议          记录、签名

包括全链路    金融/审计         ⭐⭐⭐⭐⭐  ⭐⭐⭐⭐⭐
审计(谁查的    法务诉讼          不可篡改    极其
 什么时候      高管汇报          日志记录    复杂
 答案什么)
```

**法律公司的真实例子：**
```python
# 必须实现的日志结构
audit_log = {
    "timestamp": "2025-12-22T14:30:00Z",
    "user_id": "lawyer_001",
    "query": "第三章 股东权利的内容",
    "retrieved_document": {
        "name": "公司章程v2.1.pdf",
        "upload_date": "2025-01-15",
        "chunk_id": "章程_001_chunk_12",
        "exact_location": "Page 5, Para 3-4",
        "text": "第四条 股东享有以下权利..."
    },
    "llm_response": "...",
    "confidence": 0.92,
    "was_correct": True/False,  # 律师后来验证的结果
    "signature": "hash_for_legal_binding"
}
```

---

## 📋 5 个问题的快速诊断表

在你听完 15 分钟的业务介绍后，填这个表：

```
被投公司: _________________ 行业: _________________

问题1: 文档在哪/什么格式？
  □ 内部 Wiki (Confluence)
  □ 网盘散文件 (PDF/Word/Excel)
  □ 数据库 (SQL)
  □ 图纸/CAD
  复杂度评分: ___/5

问题2: 更新频率？
  □ 每月或更少    → 批量更新
  □ 每周          → 增量更新
  □ 每天          → 实时更新
  □ 实时          → 流式处理

问题3: 谁用？
  □ 内部员工      → 简单权限
  □ B2B 客户      → 多租户隔离 ⚠️
  □ B2C 客户      → 公开内容
  □ 合规审查      → 严格权限
  复杂度评分: ___/5

问题4: 容错程度？
  □ 低 (FAQ)      → 宽松检验
  □ 中 (客户支持)  → 中等检验
  □ 高 (法律医疗)  → 严格检验
  人工参与度: ___/5

问题5: 需要追溯吗？
  □ 不需要        → 无额外成本
  □ 简单追溯      → 记录来源
  □ 精确追溯      → 记录位置 + 签名
  □ 完整审计      → 不可篡改日志
  合规难度: ___/5

─────────────────────────────────
总体复杂度评分: ___ / 25
```

---

## 🎯 各类公司的 RAG 打法速查表

### SaaS 公司
```
问题: "我们有 1000+ 个客户，每个客户有自己的产品配置文档"
   ↓
方案: 多租户 RAG (Tenant-based RAG)

关键实现:
  1. 检索前先验证租户权限 (租户ID过滤)
  2. 每个租户独立的向量索引或者通过 metadata 隔离
  3. 相似度要求更高 (避免检索到错的数据)
  
Demo 要点:
  "登录成客户A的账号，问一个问题"
  "再登录客户B的账号，问相同的问题"
  "看到完全不同的答案，但都准确"
  
技术亮点:
  ✓ 说明权限管理
  ✓ 展示多租户数据隔离
  ✓ 强调安全性
```

### 制造业
```
问题: "我们有 10000+ 张生产工艺图纸和 CAD 文件"
   ↓
方案: 多模态 RAG (Multi-modal RAG)

关键实现:
  1. OCR 提取图纸文字
  2. 图片描述模型生成标题和摘要
  3. 结合文字和图片的混合 Embedding
  4. 支持"按图查图"的能力
  
Demo 要点:
  "上传一张生产工艺图"
  "系统自动识别规格、工艺参数"
  "回答'这个零件和什么零件相容?'"
  
技术亮点:
  ✓ 展示 OCR 准确度
  ✓ 展示图纸理解能力
  ✓ 强调工程效率提升
```

### 法务/合规
```
问题: "我们有 500+ 份合同和法律文件，需要精确查询"
   ↓
方案: 高精度溯源 RAG (Precise Citation RAG)

关键实现:
  1. 小块尺寸 + 精确位置记录 (哪个文件/第几条)
  2. 引用链验证 (答案的每一句都对应来源)
  3. 严格的相似度阈值 (≥0.85 才返回)
  4. 完整的审计日志
  
Demo 要点:
  "问一个关于合同条款的问题"
  "系统不仅回答，还准确指出：来自 XXX.pdf 第 5 页第 3 条"
  "用户可以一键跳转到原文验证"
  
技术亮点:
  ✓ 零幻觉承诺
  ✓ 完整的审计链条
  ✓ 法律可用性
```

### 医疗/保险
```
问题: "医疗建议的错误导致患者伤害，责任在谁？"
   ↓
方案: 高信心医疗 RAG (Clinical-safe RAG)

关键实现:
  1. 医学知识库质量要极高 (来自权威医学数据库)
  2. 明确的免责声明
  3. 多轮确认 (系统会多角度验证)
  4. 总是建议"咨询专业医生"
  5. 严格的相似度阈值 (≥0.9)
  
Demo 要点:
  "问一个关于症状的问题"
  "系统清楚地说：这不是医疗建议，请咨询医生"
  "同时提供相关文献参考"
  
技术亮点:
  ✓ 强调医学伦理
  ✓ 明确法律责任边界
  ✓ 给信任感
```

### 内部知识库
```
问题: "我们有一个快速迭代的内部 Wiki，每周更新 100+ 页"
   ↓
方案: 高频更新知识库 RAG (Live Knowledge RAG)

关键实现:
  1. 自动监听 Wiki 更新
  2. 增量索引 (不用全量重建)
  3. 版本控制 (知道答案来自哪个版本)
  4. 实时同步 (< 5 分钟延迟)
  
Demo 要点:
  "修改 Wiki 中的某个条目"
  "刷新，系统已经获知最新信息"
  "问同样的问题，得到更新后的答案"
  
技术亮点:
  ✓ 展示 Wiki 集成能力
  ✓ 强调实时性
  ✓ 提升员工信心
```

---

## ✅ Day 2 的「够用标准」

### 学习目标
你应该能够在 15 分钟内听完业务介绍后，判断出：

```
✓ 这个问题是不是 RAG 该解决的
✓ 需要什么样的 RAG 架构
✓ 最大的技术风险是什么
✓ Demo 该怎么做才有说服力
```

### 实战能力
- 给 5 个不同行业的公司提出针对性的 RAG 方案
- 快速指出一个方案的风险所在
- 用 5 个问题框架诊断业务需求

---

## 🎬 自测题（Day 2）

### 场景 1: 房产中介
```
"我们有 1000 个楼盘的信息卡片，想让客户能问'在浦东有什么房子'
而不是一个个看卡片"

问题：
1. 这适合用 RAG 吗？ YES / NO
2. 最大的技术风险是什么？
3. Top-K 应该是多少？
4. 需要追溯吗？

标准答案：
1. YES - 是信息查询
2. 相似度阈值难设置 (地理位置/价格范围不好用向量表示)
3. K=10+ (要展示多个选项)
4. 简单追溯 (显示房号和价格)
```

### 场景 2: 银行内部
```
"我们有 2000 份合规指南文件，职员每次都问'这操作合不合规?'"

问题：
1. 这适合 RAG 吗？
2. 容错程度是？
3. 人工参与度应该多少？

标准答案：
1. YES - 典型的文档查询
2. 不能错 (违规罚款) - 容错等级最高
3. 100% (每个答案都需要合规部审核)
```

---

## 🔗 Day 2 总结清单

- [ ] 理解 5 个问题诊断法
- [ ] 能为 5 种不同行业指出 RAG 的核心挑战
- [ ] 知道权限、追溯、更新频率对架构的影响
- [ ] 能快速识别"这个问题不适合 RAG"
- [ ] 能为被投公司评估 RAG 项目的风险等级

**下一步：** Day 3 开始实现 - 编写可运行的 Demo 代码
